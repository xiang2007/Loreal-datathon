<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enterprise YouTube Comments Analyzer</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {background:#f8f9fa;}
header {background:#0d6efd;color:white;padding:20px;text-align:center;font-size:2rem;font-weight:700;}
.nav-tabs .nav-link.active {background:#0d6efd;color:white;}
.card {border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
.spinner {display:none;text-align:center;margin:20px;}
</style>
</head>
<body>
<header>YouTube Comments Analyzer</header>
<div class="container my-4">

    <div class="mb-3">
        <label class="form-label">Upload CSV Files</label>
        <input class="form-control" type="file" id="csvFiles" multiple>
    </div>
    <button class="btn btn-primary mb-3" id="downloadBtn">Download Labeled CSV</button>
    <div class="spinner" id="spinner">
        <div class="spinner-border text-primary" role="status"></div>
        <div>Processing...</div>
    </div>

    <ul class="nav nav-tabs" id="tabs">
        <li class="nav-item"><button class="nav-link active" data-tab="dashboard">Dashboard</button></li>
        <li class="nav-item"><button class="nav-link" data-tab="positive">Positive Comments</button></li>
        <li class="nav-item"><button class="nav-link" data-tab="negative">Negative Comments</button></li>
    </ul>

    <div id="tabContents" class="mt-3">
        <div id="dashboard" class="tab-pane active">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="card p-3"><h5>Sentiment Distribution</h5><canvas id="sentimentChart"></canvas></div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card p-3"><h5>Category Distribution</h5><canvas id="categoryChart"></canvas></div>
                </div>
            </div>
        </div>
        <div id="positive" class="tab-pane" style="display:none;">
            <div class="card p-3 mb-3">
                <h5>Positive Comments Category Distribution</h5>
                <select id="positiveCategoryFilter" class="form-select mb-2">
                    <option value="all">All Categories</option>
                </select>
                <canvas id="positiveCategoryChart"></canvas>
            </div>
            <div class="table-responsive"><table class="table table-striped" id="positiveTable"><thead><tr><th>Comment</th><th>Category</th></tr></thead><tbody></tbody></table></div>
        </div>
        <div id="negative" class="tab-pane" style="display:none;">
            <div class="card p-3 mb-3">
                <h5>Negative Comments Category Distribution</h5>
                <select id="negativeCategoryFilter" class="form-select mb-2">
                    <option value="all">All Categories</option>
                </select>
                <canvas id="negativeCategoryChart"></canvas>
            </div>
            <div class="table-responsive"><table class="table table-striped" id="negativeTable"><thead><tr><th>Comment</th><th>Category</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

</div>

<script>
// TAB NAVIGATION
const tabs = document.querySelectorAll("#tabs .nav-link");
const tabContents = document.querySelectorAll("#tabContents .tab-pane");
tabs.forEach(tab => {
    tab.addEventListener('click', ()=>{
        tabs.forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        tabContents.forEach(tc=>tc.style.display='none');
        document.getElementById(tab.dataset.tab).style.display='block';
        if(tab.dataset.tab==='positive') renderPositive();
        if(tab.dataset.tab==='negative') renderNegative();
    });
});

let data=[], positiveData=[], negativeData=[];

// UTILS
function countByField(data,field){
    const counts={};
    data.forEach(r=>{counts[r[field]]=(counts[r[field]]||0)+1;});
    return counts;
}

function fillTable(tableId, rows){
    const tbody=document.querySelector(`#${tableId} tbody`);
    tbody.innerHTML="";
    rows.forEach(r=>{
        const tr=document.createElement('tr');
        const td1=document.createElement('td'); td1.textContent=r.clean_comment;
        const td2=document.createElement('td'); td2.textContent=r.category;
        tr.append(td1,td2); tbody.appendChild(tr);
    });
}

const charts = {}; // store chart instances

function createBarChart(canvasId, data, color="#0d6efd"){
    const counts = countByField(data,"category");
    const labels = Object.keys(counts);
    const values = Object.values(counts);
    const ctx = document.getElementById(canvasId).getContext('2d');

    // Destroy previous chart if exists
    if(charts[canvasId]){
        charts[canvasId].destroy();
    }

    charts[canvasId] = new Chart(ctx,{
        type:"bar",
        data:{labels, datasets:[{label:"Category", data:values, backgroundColor:color}]},
        options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,ticks:{precision:0}}}}
    });
}


// RENDER FUNCTIONS
function renderPositive(){
    const filtered = positiveData.filter(r=>r.category!=="general" && r.category!=="other");
    const select=document.getElementById("positiveCategoryFilter");
    select.innerHTML='<option value="all">All Categories</option>';
    [...new Set(filtered.map(r=>r.category))].forEach(cat=>{
        const opt=document.createElement("option"); opt.value=cat; opt.textContent=cat;
        select.appendChild(opt);
    });
    createBarChart("positiveCategoryChart",filtered,"#198754");
    fillTable("positiveTable", filtered);
}
function renderNegative(){
    const filtered = negativeData.filter(r=>r.category!=="general" && r.category!=="other");
    const select=document.getElementById("negativeCategoryFilter");
    select.innerHTML='<option value="all">All Categories</option>';
    [...new Set(filtered.map(r=>r.category))].forEach(cat=>{
        const opt=document.createElement("option"); opt.value=cat; opt.textContent=cat;
        select.appendChild(opt);
    });
    createBarChart("negativeCategoryChart",filtered,"#dc3545");
    fillTable("negativeTable", filtered);
}

// FILTER EVENT
document.getElementById("positiveCategoryFilter").addEventListener("change", e=>{
    const cat=e.target.value;
    const filtered = positiveData.filter(r=>r.category!=="general" && r.category!=="other");
    fillTable("positiveTable", cat==="all"?filtered:filtered.filter(r=>r.category===cat));
});
document.getElementById("negativeCategoryFilter").addEventListener("change", e=>{
    const cat=e.target.value;
    const filtered = negativeData.filter(r=>r.category!=="general" && r.category!=="other");
    fillTable("negativeTable", cat==="all"?filtered:filtered.filter(r=>r.category===cat));
});

// FILE UPLOAD
const spinner = document.getElementById("spinner");
document.getElementById("csvFiles").addEventListener("change", async e=>{
    const files=e.target.files;
    if(!files.length) return;
    spinner.style.display="block";
    const formData = new FormData();
    for(let f of files) formData.append("files",f);
    try{
        const res = await fetch("/upload",{method:"POST",body:formData});
        const json = await res.json();
        if(json.error) {alert(json.error); spinner.style.display="none"; return;}
        data=json.data;
        positiveData = data.filter(r=>r.sentiment==="positive");
        negativeData = data.filter(r=>r.sentiment==="negative");

        // Dashboard charts
        const sentimentCounts = countByField(data,"sentiment");
        new Chart(document.getElementById("sentimentChart").getContext("2d"),{
            type:"pie",
            data:{
                labels:Object.keys(sentimentCounts),
                datasets:[{data:Object.values(sentimentCounts), backgroundColor:["#198754","#dc3545","#ffc107"]}]
            },
            options:{responsive:true}
        });
        createBarChart("categoryChart",data);
        spinner.style.display="none";

        // Render active tab
        const activeTab = document.querySelector("#tabs .nav-link.active").dataset.tab;
        if(activeTab==='positive') renderPositive();
        if(activeTab==='negative') renderNegative();
    }catch(err){alert(err); spinner.style.display="none";}
});

// DOWNLOAD BUTTON
document.getElementById("downloadBtn").addEventListener("click", async ()=>{
    const files=document.getElementById("csvFiles").files;
    if(!files.length){alert("Upload files first!"); return;}
    const formData = new FormData();
    for(let f of files) formData.append("files",f);
    const res=await fetch("/download",{method:"POST",body:formData});
    const blob=await res.blob();
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="labeled_comments.csv"; a.click();
});
</script>

</body>
</html>
